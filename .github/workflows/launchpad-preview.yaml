###
# Preview
# ------------
# This workflow deploy & clean up the preview environment.
#
# IMPORTANT: Managed by LaunchPad DO NOT EDIT!
###

name: "Preview [LaunchPad]"

on:
  pull_request:
    types:
      - closed
    branches:
      - main
      - master
  workflow_run:
    workflows:
      - "test"
#    branches:
#      - main
#      - master
    types:
      - completed

jobs:

  ##
  # Deploy Preview
  # -----
  # Deploy a preview version of the application.
  ##
  deployPreview:
    name: Deploy Preview Service
    runs-on: ubuntu-latest
    if: github.event.type == 'completed'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v1
      - name: Parse the "launchpad.yaml" Config
        id: parseConfig
        uses: bluenovaio/launchpad-parser@v1.0.0
      - name: Deploy Preview Service
        id: deploy
        uses: bluenovaio/deploy-cloudrun@main
        with:
          action: deploy
          image: gcr.io/${{ secrets.GCP_OPS_PROJECT_ID }}/preview-${{ fromJSON(steps.parseConfig.outputs.contents).name }}:${{ github.sha }}
          service: "preview-${{ fromJSON(steps.parseConfig.outputs.contents).name }}-${{ github.sha }}"
          credentials: ${{ secrets.GCP_PREPRD_PROJECT_SA_KEY }}
      - name: Post Preview Deploy URL
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const response = await github.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            }) || [];

            let found = false;

            response.data.forEach((comment) => {
              found = comment.body.includes(':rocket: **LaunchPad**:');
            });

            if (!found) {
              github.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: ':rocket: **LaunchPad**: You can view the preview here: [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})'
              });
            }

  ##
  # Clean-up Preview
  # -----
  # Cleanup the preview version of the application on Merge.
  ##
  cleanUpPreview:
    name: Cleanup Preview Service
    runs-on: ubuntu-latest
    if: github.event.type == 'closed' || github.event.type == 'synchronize'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v1
      - name: Parse the "launchpad.yaml" Config
        id: parseConfig
        uses: bluenovaio/launchpad-parser@v1.0.0
      - name: Delete Preview Service
        id: delete
        uses: bluenovaio/deploy-cloudrun@main
        with:
          action: delete
          service: "preview-${{ fromJSON(steps.parseConfig.outputs.contents).name }}-${{ github.sha }}"
          credentials: ${{ secrets.GCP_PREPRD_PROJECT_SA_KEY }}
